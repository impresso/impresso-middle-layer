import assert from 'assert'
import { getSolrErrorDetails } from '../../../src/util/solr/errors'
import solrSuccessfulResponse from './responses/solrSuccessfulResponse.json'
import solrExceptionUndefinedField from './responses/solrExceptionUndefinedField.json'
import solrErrorTimeout from './responses/solrErrorTimeout.json'

describe('getSolrErrorDetails', () => {
  it('returns undefined for successful response (status 0)', () => {
    const result = getSolrErrorDetails(solrSuccessfulResponse)
    assert.strictEqual(result, undefined)
  })

  it('parses 400 error with undefined field', () => {
    const result = getSolrErrorDetails(solrExceptionUndefinedField)
    assert.notStrictEqual(result, undefined)
    assert.strictEqual(result?.code, 400)
    assert.strictEqual(result?.message, 'undefined field 123')
    assert.strictEqual(
      result?.params,
      JSON.stringify({
        q: '123:asdf',
        indent: 'true',
        'q.op': 'OR',
        useParams: '',
        _: '1761145712120',
      })
    )
  })

  it('parses timeout error', () => {
    const result = getSolrErrorDetails(solrErrorTimeout)
    assert.notStrictEqual(result, undefined)
    assert.strictEqual(result?.code, 504)
    assert.strictEqual(
      result?.message,
      'org.apache.solr.client.solrj.SolrServerException: Idle timeout expired: 30000 ms'
    )
    assert.strictEqual(
      result?.params,
      '{"query":"{!knn f=gte_multi_v768 topK=30}[-0.0028377315029501915,0.042710356414318085,0.021607981994748116,0.005953059997409582,0.01586749404668808,-0.06119700148701668,-0.03345736116170883,0.056567996740341187,0.09035235643386841,0.004183650482445955,-0.03599826619029045,-0.015278976410627365,-0.038998205214738846,0.08011066913604736,-0.06183750927448273,0.025696968659758568,0.06853622943162918,0.08116449415683746,0.07211624085903168,0.003045769175514579,0.041546549648046494,0.11174006015062332,-0.05266871303319931,-0.031795404851436615,-0.019974175840616226,0.007186647038906813,0.05021131411194801,-0.07777391374111176,-0.0554906390607357,0.03550391644239426,-0.02651374600827694,-0.04705825075507164,0.021935470402240753,0.03946275636553764,0.11323937773704529,0.014172040857374668,0.062388449907302856,0.05739245191216469,-0.09676889330148697,-0.02841871604323387,-0.01667824573814869,-0.05961427837610245,-0.03168237954378128,0.0030803922563791275,-0.04050194472074509,-0.003084322204813361,-0.019353169947862625,0.012821845710277557,-0.052248790860176086,0.04954485595226288,-0.04383087530732155,-0.01604248210787773,0.018657293170690536,-0.0035194980446249247,0.02093091607093811,0.005109928082674742,-0.061964623630046844,-0.023822061717510223,0.077448770403862,-0.045290134847164154,0.013560540974140167,-0.0037926097866147757,-0.009705106727778912,-0.0017636838601902127,-0.0495743602514267,0.013150710612535477,0.037785641849040985,-0.025822650641202927,0.09815596044063568,-0.003655597334727645,-0.019035130739212036,0.0041051278822124004,-0.06369144469499588,0.004201478324830532,-0.026060758158564568,0.0044554453343153,-0.06284535676240921,0.019359102472662926,0.08360608667135239,0.02507634647190571,-0.08290325105190277,-0.055509015917778015,0.059919536113739014,0.02419828251004219,0.009893780574202538,-0.019503053277730942,0.0045464178547263145,-0.039498284459114075,0.0031867267098277807,0.031601425260305405,0.04377879947423935,0.028361745178699493,0.0021699739154428244,-0.01270575262606144,0.0148919140920043,0.043378934264183044,-0.06201312690973282,-0.028115253895521164,0.01736055687069893,0.0448862724006176,-0.027865510433912277,0.04291656240820885,0.01124451495707035,0.04804741218686104,-0.00808467622846365,0.009226984344422817,0.029910046607255936,0.0016281544230878353,-0.028825927525758743,-0.03649413585662842,-0.06377002596855164,-0.0009746240102685988,-0.006872812286019325,-0.03865634649991989,-0.041636623442173004,0.04168067127466202,0.0572148896753788,-0.0261220782995224,-0.02166297286748886,0.017675673589110374,-0.007037521805614233,-0.026642894372344017,-0.03452890366315842,-0.01754513569176197,-0.07493339478969574,0.023250846192240715,0.015168802812695503,-0.036481428891420364,-0.03117983601987362,-0.014101145789027214,0.09630387276411057,0.0016003515338525176,0.0444471575319767,-0.06478115916252136,-0.0513213649392128,-0.022002296522259712,0.02988501265645027,0.07022495567798615,0.012711725197732449,0.02013532444834709,-0.020487695932388306,0.06390134245157242,-0.08228179067373276,-0.008774667978286743,0.05022752285003662,0.02180328406393528,0.021590346470475197,-0.00196301587857306,0.015012379735708237,0.0064214314334094524,-0.057955071330070496,0.04268645495176315,0.06068527325987816,-0.04376870021224022,0.014949128963053226,-0.009149933233857155,0.03233470395207405,0.03954682499170303,-0.015026664361357689,-0.05101387947797775,0.04759984835982323,0.014439296908676624,-0.01772466115653515,-0.0302752498537302,-0.03938483074307442,-0.05178714543581009,0.017081068828701973,0.08835391700267792,0.001265871338546276,0.013773755170404911,-0.047147057950496674,0.03290504589676857,-0.003824585350230336,-0.02828393131494522,0.0035875800531357527,-0.007515295874327421,-0.02756522037088871,0.02605273388326168,-0.02303917706012726,0.05286214500665665,-0.01933673396706581,-0.027533210813999176,-0.011281068436801434,-0.0038177999667823315,0.037605613470077515,-0.0020647956989705563,-0.03239302709698677,0.01566190831363201,0.03204530104994774,0.00880553387105465,-0.03518453985452652,-0.07908104360103607,-0.059055179357528687,0.032076261937618256,-0.0025699709076434374,-0.02282082661986351,0.005406418815255165,0.016971701756119728,-0.04138173907995224,0.007047806400805712,0.026319466531276703,0.031519513577222824,0.05470844730734825,0.014859775081276894,0.005540075246244669,-0.03082338161766529,-0.013175460509955883,-0.023051375523209572,0.006917150691151619,-0.0023412699811160564,0.0601809024810791,0.06117790564894676,0.018892943859100342,0.025592342019081116,-0.010608923621475697,-0.03390756621956825,-0.01933288387954235,-0.04388585314154625,0.04914912208914757,-0.0338502861559391,-0.011959941126406193,-0.008745052851736546,-0.06309438496828079,-0.00921791885048151,0.03480256721377373,0.017759954556822777,-0.01763712614774704,0.024178100749850273,0.006918915081769228,-0.010734711773693562,-0.019939841702580452,-0.026567058637738228,0.04240797460079193,-0.06193413957953453,-0.02665209025144577,-0.004593790974467993,-0.00448971800506115,0.002422824501991272,0.022808153182268143,0.04920128360390663,-0.006925112567842007,-0.03156335651874542,0.031049689278006554,0.06584707647562027,-0.0069849323481321335,-0.025228165090084076,-0.06046499311923981,-0.029773641377687454,-0.01168127916753292,-0.02602900192141533,-0.04191211238503456,0.025914832949638367,-0.0023156260140240192,-0.05839464068412781,0.022098971530795097,0.02647407352924347,0.04390620440244675,0.06072403863072395,0.009685071185231209,-0.04157152399420738,-0.0032808417454361916,-0.020417841151356697,-0.04187077656388283,0.004970486741513014,0.0456046424806118,-0.1247880682349205,-0.00008990891365101561,0.02794841304421425,0.027436526492238045,-0.06693349033594131,-0.007017082534730434,-0.02524770237505436,0.026332903653383255,-0.03196321427822113,-0.06326816231012344,0.0037726135924458504,-0.05458835884928703,-0.015959352254867554,-0.020288465544581413,0.004180047661066055,0.029572105035185814,0.007393402513116598,0.013162354938685894,-0.021352894604206085,-0.04013495519757271,0.06253611296415329,0.04561421275138855,-0.04811231046915054,-0.012298747897148132,0.0754847377538681,-0.046506065875291824,0.014574497938156128,-0.002169419778510928,0.039446767419576645,-0.007156544364988804,-0.0011584392050281167,-0.02583213709294796,-0.011808045208454132,-0.000052169150876579806,-0.01729133166372776,-0.01769046112895012,-0.021660199388861656,-0.011548209935426712,0.03624168783426285,-0.030514536425471306,-0.025256214663386345,-0.08952247351408005,-0.07185307145118713,0.03411586955189705,0.04023941978812218,0.00564002338796854,-0.0377296507358551,-0.015705198049545288,-0.074971504509449,0.0013838984305039048,0.04340318590402603,0.03739209473133087,0.040084417909383774,-0.01990692876279354,-0.035718709230422974,0.023296408355236053,0.11406703293323517,-0.057488348335027695,0.035321831703186035,-0.008853111416101456,-0.016809789463877678,0.03890759125351906,0.017819197848439217,-0.018671199679374695,-0.019842112436890602,-0.00457714544609189,0.014876403845846653,0.005147392861545086,-0.07696718722581863,0.025896161794662476,0.06886064261198044,0.03272757679224014,-0.026250556111335754,-0.01003519631922245,0.00835702009499073,0.010235327295958996,0.04912419244647026,0.0011040905956178904,0.03581732511520386,0.053986940532922745,0.004156488459557295,0.07137100398540497,-0.0053049433045089245,0.018947500735521317,0.004971805959939957,0.033407848328351974,0.017505325376987457,0.05516199767589569,-0.0006334934732876718,0.050798673182725906,-0.05466386303305626,-0.009771445766091347,0.008376560173928738,-0.03224848210811615,0.03681696578860283,0.03459145501255989,-0.02118973806500435,0.01812068559229374,0.018015176057815552,-0.004846722353249788,-0.01454290933907032,-0.0098740728572011,0.039707012474536896,0.014521927572786808,0.027928732335567474,0.05074925720691681,0.03208199143409729,0.007766739930957556,0.06773728877305984,-0.03983450308442116,-0.010501617565751076,0.012574799358844757,0.029504740610718727,0.00790392979979515,0.0031285840086638927,0.016058139503002167,0.019096190109848976,0.01702919974923134,-0.02306894212961197,0.022644296288490295,0.0013763023307546973,-0.00867924652993679,-0.006020194385200739,-0.020712660625576973,-0.07640685141086578,0.01926247775554657,-0.03528119996190071,0.012923553586006165,0.006158063188195229,0.04820069298148155,0.0038650447968393564,-0.0007284964085556567,0.021702196449041367,-0.039641331881284714,0.003390453290194273,-0.04011233523488045,0.02913896180689335,0.026307182386517525,0.03961469978094101,0.021134784445166588,0.03653330355882645,0.009317141026258469,-0.0771673321723938,0.011864486150443554,-0.006981036625802517,0.01993241161108017,-0.06919284909963608,0.0068695927038788795,-0.06457168608903885,0.061395104974508286,0.029988469555974007,0.012247424572706223,0.02626994252204895,0.16672249138355255,0.003468526527285576,-0.003454978112131357,0.030497431755065918,0.04315341264009476,-0.02437143586575985,-0.01138903945684433,0.05113521218299866,0.014008194208145142,-0.007490215357393026,-0.01879013143479824,0.011536719277501106,-0.017778141424059868,0.04372691363096237,0.060239940881729126,-0.018650416284799576,-0.07252755761146545,-0.034270066767930984,-0.011961106210947037,0.0002794013707898557,0.04543989524245262,0.002109118504449725,0.060516126453876495,0.04565175622701645,0.02990652434527874,-0.00974368304014206,-0.004949002061039209,-0.06723663210868835,0.04160991683602333,-0.03870648518204689,-0.019914181903004646,0.024104265496134758,-0.05688759312033653,0.019833393394947052,-0.00968514010310173,0.013622520491480827,0.028045540675520897,-0.0369725339114666,-0.018681427463889122,0.006322589702904224,0.033037833869457245,-0.0342942550778389,-0.023092783987522125,-0.005477027967572212,-0.02402474544942379,-0.033623918890953064,0.10336784273386002,0.016856256872415543,0.02663866989314556,0.04735160619020462,0.0067633651196956635,0.018705062568187714,-0.01897207833826542,0.0249108225107193,0.020003]","limit":1,"offset":0,"filter":["meta_country_code_s:FR"],"sort":"ocrqa_f desc","fields":"id,meta_issue_id_s,meta_source_type_s,meta_date_dt,meta_journal_s,meta_source_medium_s,meta_country_code_s,meta_province_code_s,meta_partnerid_s,rights_copyright_s,rights_data_domain_s,rights_bm_explore_l,rights_bm_get_tr_l,rights_bm_get_img_l,lg_s,title_txt,content_txt,content_length_i,doc_type_s,item_type_s,lg_orig_s,snippet_plain,cc_b,front_b,nb_pages_i,rc_plains,page_id_ss,page_nb_is,ocrqa_f,pers_entities_dpfs,loc_entities_dpfs,nag_entities_dpfs,org_entities_dpfs,topics_dpfs,pers_mention_conf_dpfs,loc_mention_conf_dpfs,org_mention_conf_dpfs,nag_mention_conf_dpfs,nem_offset_plain:[json],nag_offset_plain:[json],meta_duration_s,meta_start_time_s,nb_record_i,record_id_ss,record_nb_is,title_txt_*,rrreb_plain:[json]","params":{"hl":false}}'
    )
  })

  it('returns undefined when responseHeader status is 0', () => {
    const response = {
      responseHeader: {
        status: 0,
        QTime: 1,
      },
      response: {
        numFound: 100,
        docs: [],
      },
    }
    const result = getSolrErrorDetails(response)
    assert.strictEqual(result, undefined)
  })

  it('handles error with 400 status code', () => {
    const response = {
      responseHeader: {
        status: 400,
        QTime: 0,
      },
      error: {
        msg: 'Bad query syntax',
        code: 400,
      },
    }
    const result = getSolrErrorDetails(response)
    assert.notStrictEqual(result, undefined)
    assert.strictEqual(result?.code, 400)
    assert.strictEqual(result?.message, 'Bad query syntax')
  })

  it('handles error with 500 status code', () => {
    const response = {
      responseHeader: {
        status: 500,
        QTime: 100,
      },
      error: {
        msg: 'Internal server error',
        code: 500,
      },
    }
    const result = getSolrErrorDetails(response)
    assert.notStrictEqual(result, undefined)
    assert.strictEqual(result?.code, 500)
    assert.strictEqual(result?.message, 'Internal server error')
  })

  it('handles timeout error with 504 status code in error object', () => {
    const response = {
      responseHeader: {
        status: 500,
        QTime: 30000,
      },
      error: {
        msg: 'Service timeout',
        code: 504,
      },
    }
    const result = getSolrErrorDetails(response)
    assert.notStrictEqual(result, undefined)
    assert.strictEqual(result?.code, 504)
    assert.strictEqual(result?.message, 'Service timeout')
  })

  it('returns undefined when no error object present and status is 0', () => {
    const response = {
      responseHeader: {
        status: 0,
      },
    }
    const result = getSolrErrorDetails(response)
    assert.strictEqual(result, undefined)
  })

  it('handles response with error object but missing msg field', () => {
    const response = {
      responseHeader: {
        status: 400,
      },
      error: {
        code: 400,
      },
    }
    const result = getSolrErrorDetails(response)
    assert.notStrictEqual(result, undefined)
    assert.strictEqual(result?.code, 400)
    assert.ok(result?.message !== undefined)
  })

  it('handles response with error object but missing code field', () => {
    const response = {
      responseHeader: {
        status: 500,
      },
      error: {
        msg: 'Something went wrong',
      },
    }
    const result = getSolrErrorDetails(response)
    assert.notStrictEqual(result, undefined)
    assert.strictEqual(result?.code, 500)
    assert.strictEqual(result?.message, 'Something went wrong')
  })

  it('handles malformed response body gracefully', () => {
    const response = {
      responseHeader: {
        status: 500,
      },
    }
    const result = getSolrErrorDetails(response)
    // Should detect error based on status code even without error object
    assert.notStrictEqual(result, undefined)
    assert.strictEqual(result?.code, 500)
  })

  it('extracts message from nested error structure', () => {
    const response = {
      responseHeader: {
        status: 400,
        QTime: 5,
      },
      error: {
        metadata: ['error-class', 'org.apache.solr.common.SolrException'],
        msg: 'Cannot parse query',
        code: 400,
      },
    }
    const result = getSolrErrorDetails(response)
    assert.notStrictEqual(result, undefined)
    assert.strictEqual(result?.code, 400)
    assert.strictEqual(result?.message, 'Cannot parse query')
  })
})
